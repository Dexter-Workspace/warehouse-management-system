<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Management System - Firebase Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --gray: #64748b;
            --light: #f1f5f9;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-container {
            display: none;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .app-container.active {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--dark) 0%, #334155 100%);
            color: white;
            padding: 2rem;
            transition: all 0.3s ease;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        }

        .company-selector {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .company-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .company-selector select:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 3rem;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }

        .nav-icon {
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        .logout-btn {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-title {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0.1;
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .stat-change {
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            display: inline-block;
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Forms */
        .form-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 500;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        tbody tr {
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: scale(1.01);
        }

        /* Filter Section */
        .filter-section {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        /* Import/Export Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 0.75rem 1.5rem;
            background: var(--success);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        /* Charts Container */
        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .chart-placeholder {
            text-align: center;
            color: var(--gray);
        }

        /* Loading Animation */
        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-overlay.active {
            display: flex;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                z-index: 1000;
                height: 100vh;
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 9999;
            max-width: 350px;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 9998;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            animation: modalSlide 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--dark);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1 class="login-title">WMS Pro</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Login</button>
            </form>
            <div style="margin-top: 1rem; text-align: center;">
                <small style="color: var(--gray);">Don't have an account? <a href="#" onclick="showSignup()" style="color: var(--primary);">Sign up</a></small>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">WMS Pro</div>
            
            <!-- Company Selector -->
            <div class="company-selector">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.8;">Current Company</label>
                <select id="companySelect" onchange="switchCompany()">
                    <!-- Companies will be loaded dynamically -->
                </select>
            </div>

            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <div class="nav-link active" onclick="showSection('dashboard', this)">
                            <span class="nav-icon">üìä</span>
                            Dashboard
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="nav-link" onclick="showSection('forecast', this)">
                            <span class="nav-icon">üìà</span>
                            Forecast
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="nav-link" onclick="showSection('inventory', this)">
                            <span class="nav-icon">üì¶</span>
                            Inventory
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="nav-link" onclick="showSection('sales', this)">
                            <span class="nav-icon">üí∞</span>
                            Sales
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="nav-link" onclick="showSection('sales-order', this)">
                            <span class="nav-icon">üìù</span>
                            Sales Orders
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="nav-link" onclick="showSection('purchase', this)">
                            <span class="nav-icon">üõí</span>
                            Purchase
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="nav-link" onclick="showSection('settings', this)">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            Settings
                        </div>
                    </li>
                </ul>
            </nav>

            <div class="logout-btn">
                <div class="nav-link" onclick="logout()">
                    <span class="nav-icon">üö™</span>
                    Logout
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <span id="userDisplay">Welcome</span>
                    <div class="user-avatar" id="userAvatar">U</div>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Inventory Value</div>
                        <div class="stat-value" id="totalInventoryValue">$0</div>
                        <span class="stat-change positive">Calculating...</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Items</div>
                        <div class="stat-value" id="totalItems">0</div>
                        <span class="stat-change positive">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Low Stock Items</div>
                        <div class="stat-value" id="lowStockItems">0</div>
                        <span class="stat-change negative">Checking...</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Orders</div>
                        <div class="stat-value" id="pendingOrders">0</div>
                        <span class="stat-change positive">Processing</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Today's Sales</div>
                        <div class="stat-value" id="todaysSalesDashboard">$0</div>
                        <span class="stat-change positive">Today</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Monthly Revenue</div>
                        <div class="stat-value" id="monthlyRevenue">$0</div>
                        <span class="stat-change positive">This Month</span>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="dashboardChart"></canvas>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Top Selling Category</div>
                        <div class="stat-value" id="topCategory">-</div>
                        <span class="stat-change positive">This Month</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Order Value</div>
                        <div class="stat-value" id="avgOrderValue">$0</div>
                        <span class="stat-change positive">This Month</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Stock Turnover Rate</div>
                        <div class="stat-value" id="turnoverRate">0%</div>
                        <span class="stat-change positive">This Month</span>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem;">Recent Activities</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivitiesTable">
                            <tr>
                                <td colspan="5" class="empty-state">
                                    <div class="empty-state-icon">üìã</div>
                                    <p>No recent activities</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>


            <!-- Forecast Section -->
            <section id="forecast" class="content-section">
                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="forecastStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="forecastEndDate">
                        </div>
                        <div class="filter-grid">
                            <div class="form-group">
                                <label class="form-label">Search Item</label>
                                <input type="text" class="form-input" placeholder="Enter item name or SKU" id="forecastSearch">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="forecastCategory">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Forecast Period</label>
                            <select class="form-select" id="forecastDays">
                                <option value="7">7 Days</option>
                                <option value="10">10 Days</option>
                                <option value="15">15 Days</option>
                                <option value="30">30 Days</option>
                                <option value="60">60 Days</option>
                                <option value="90">90 Days</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateForecast()">Generate Report</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Predicted Forecast Amount</div>
                        <div class="stat-value" id="predictedDemand">$0</div>
                        <span class="stat-change positive">Units next month</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Recommended Order</div>
                        <div class="stat-value" id="recommendedOrder">0</div>
                        <span class="stat-change positive">Units to order</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Stock Coverage</div>
                        <div class="stat-value" id="stockCoverage">0</div>
                        <span class="stat-change positive">Days</span>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="forecastChart"></canvas>
                </div>

                <div class="table-container" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1.5rem;">Suggested Orders</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Current Stock</th>
                                <th>Forecast Demand</th>
                                <th>Suggested Order</th>
                                <th>Order Priority</th>
                            </tr>
                        </thead>
                        <tbody id="suggestedOrdersTable">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div class="empty-state-icon">üìã</div>
                                    <p>Generate forecast to see suggested orders</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </section>

            <!-- Inventory Section -->
            <section id="inventory" class="content-section">
                <div class="action-buttons">
                    <div class="file-input-wrapper">
                        <input type="file" id="inventoryImport" accept=".csv" onchange="importCSV('inventory')">
                        <label for="inventoryImport" class="file-input-label">üì• Import CSV</label>
                    </div>
                    <button class="btn btn-secondary" onclick="exportCSV('inventory')">üì§ Export CSV</button>
                    <button class="btn btn-success" onclick="showAddInventoryModal()">+ Add Item</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Stock Value</div>
                        <div class="stat-value" id="totalStockValue">$0</div>
                        <span class="stat-change positive">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total SKUs</div>
                        <div class="stat-value" id="totalSKUs">0</div>
                        <span class="stat-change positive">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Low Stock Alert</div>
                        <div class="stat-value" id="lowStockAlert">0</div>
                        <span class="stat-change negative">Items below threshold</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Out of Stock</div>
                        <div class="stat-value" id="outOfStock">0</div>
                        <span class="stat-change negative">Needs reorder</span>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label class="form-label">Search Item</label>
                            <input type="text" class="form-input" placeholder="Enter item name or SKU" id="inventorySearch">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="inventoryCategory">
                                <option>All Categories</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="searchInventory()">üîç Search</button>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem;">Current Inventory</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total Value</th>
                                <th>Last Updated</th>
                                <th>Stock Alert</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <div class="empty-state-icon">üì¶</div>
                                    <p>No inventory items found</p>
                                    <button class="btn btn-primary" onclick="showAddInventoryModal()" style="margin-top: 1rem;">Add First Item</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Sales Section -->
            <section id="sales" class="content-section">
                <div class="action-buttons">
                    <div class="file-input-wrapper">
                        <input type="file" id="salesImport" accept=".csv" onchange="importCSV('sales')">
                        <label for="salesImport" class="file-input-label">üì• Import CSV</label>
                    </div>
                    <button class="btn btn-secondary" onclick="exportCSV('sales')">üì§ Export CSV</button>
                    <button class="btn btn-success" onclick="showAddSaleModal()">+ Record Sale</button>
                </div>

                  <div class="filter-section">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label class="form-label">Search Item/Customer</label>
                            <input type="text" class="form-input" id="salesSearch" placeholder="Enter item name, SKU or customer">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="salesStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="salesEndDate">
                        </div>
                        <button class="btn btn-primary" onclick="searchSales()">üîç Search</button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Today's Sales</div>
                        <div class="stat-value" id="todaysSales">$0</div>
                        <span class="stat-change positive">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Units Sold Today</div>
                        <div class="stat-value" id="unitsSoldToday">0</div>
                        <span class="stat-change positive">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Order Value</div>
                        <div class="stat-value" id="avgOrderValue">$0</div>
                        <span class="stat-change positive">Loading...</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Transactions</div>
                        <div class="stat-value" id="totalTransactions">0</div>
                        <span class="stat-change positive">Loading...</span>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem;">Recent Sales Transactions</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice Date</th>
                                <th>Invoice No.</th>
                                <th>Item SKU</th>
                                <th>Customer Name</th>
                                <th>Item Name</th>
                                <th>Unit Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <div class="empty-state-icon">üí∞</div>
                                    <p>No sales transactions found</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Sales Orders Section -->
            <section id="sales-order" class="content-section">
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="showNewOrderModal()">+ New Order</button>
                    <button class="btn btn-secondary" onclick="exportCSV('orders')">üì§ Export Orders</button>
                </div>

                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label class="form-label">Search Order/Customer</label>
                            <input type="text" class="form-input" id="ordersSearch" placeholder="Enter order ID or customer">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="ordersStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="ordersEndDate">
                        </div>
                        <button class="btn btn-primary" onclick="searchOrders()">üîç Search</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value" id="totalOrders">0</div>
                        <span class="stat-change positive">All time</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Orders</div>
                        <div class="stat-value" id="pendingOrdersCount">0</div>
                        <span class="stat-change negative">Awaiting processing</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Completed Orders</div>
                        <div class="stat-value" id="completedOrders">0</div>
                        <span class="stat-change positive">This month</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Order Value</div>
                        <div class="stat-value" id="totalOrderValue">$0</div>
                        <span class="stat-change positive">This month</span>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem;">Sales Orders</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>SO No.</th>
                                <th>Ship Date</th>
                                <th>Customer Name</th>
                                <th>SKU</th>
                                <th>Item Name</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <div class="empty-state-icon">üìù</div>
                                    <p>No orders found</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Purchase Section -->
            <section id="purchase" class="content-section">
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="showAddPurchaseModal()">+ New Purchase</button>
                    <button class="btn btn-secondary" onclick="exportCSV('purchase')">üì§ Export Purchases</button>
                </div>
                
                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label class="form-label">Search Item/Supplier</label>
                            <input type="text" class="form-input" id="purchaseSearch" placeholder="Enter item name, SKU or supplier">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="purchaseStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="purchaseEndDate">
                        </div>
                        <button class="btn btn-primary" onclick="searchPurchases()">üîç Search</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Purchases</div>
                        <div class="stat-value" id="totalPurchases">$0</div>
                        <span class="stat-change positive">This month</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active POs</div>
                        <div class="stat-value" id="activePOs">0</div>
                        <span class="stat-change positive">In progress</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Suppliers</div>
                        <div class="stat-value" id="suppliersCount">0</div>
                        <span class="stat-change positive">Active</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Items Purchased</div>
                        <div class="stat-value" id="itemsPurchased">0</div>
                        <span class="stat-change positive">This month</span>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 1.5rem;">Recent Purchases</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>PO No.</th>
                                <th>Purchase Date</th>
                                <th>Supplier Name</th>
                                <th>SKU</th>
                                <th>Item Name</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="purchaseTable">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <div class="empty-state-icon">üõí</div>
                                    <p>No purchase records found</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="form-container">
                    <h3 style="margin-bottom: 2rem;">Company Management</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-input" id="newCompanyName" placeholder="Enter company name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Industry</label>
                            <select class="form-select" id="newCompanyIndustry">
                                <option>Manufacturing</option>
                                <option>Retail</option>
                                <option>Distribution</option>
                                <option>E-commerce</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" style="margin-top: 1.7rem;" onclick="addCompany()">Add Company</button>
                        </div>
                    </div>

                    <div class="table-container" style="margin-top: 2rem; padding: 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company Name</th>
                                    <th>Industry</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="companiesTable">
                                <tr>
                                    <td colspan="4" class="empty-state">Loading companies...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-container" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 2rem;">Low Stock Settings</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Low Stock Threshold</label>
                            <input type="number" class="form-input" id="itemLowStockThreshold" value="10" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Low Stock Alert Email</label>
                            <input type="email" class="form-input" id="lowStockAlertEmail" placeholder="Enter email for alerts">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" style="margin-top: 1.7rem;" onclick="saveLowStockSettings()">Save Settings</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText">Operation completed successfully!</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loader"></div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Modal Title</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc,
            query,
            where,
            orderBy,
            limit,
            onSnapshot,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Your Firebase configuration
        // REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDtQO34xj_F0Yvn8EeBGKbhsDr11LxH_p8",
            authDomain: "warehouse-management-sys-13896.firebaseapp.com",
            projectId: "warehouse-management-sys-13896",
            storageBucket: "warehouse-management-sys-13896.firebasestorage.app",
            messagingSenderId: "982323352884",
            appId: "1:982323352884:web:34709f57bb6268e056c161"
            };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebase = {
            auth,
            db,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            getDocs,
            doc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            limit,
            onSnapshot,
            serverTimestamp
        };

        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
        }

        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
        }

        // Initialize auth state listener
        onAuthStateChanged(auth, (user) => {
            console.log('Auth state changed:', user ? user.email : 'No user');
            if (user) {
                window.currentUser = user;
                showApp();
                loadUserData().then(() => {
                    console.log('User data loaded');
                }).catch(error => {
                    console.error('Error loading user data:', error);
                });
            } else {
                window.currentUser = null;
                // Clear stored data
                localStorage.removeItem('selectedCompanyId');
                currentCompany = null;
                companies = [];
                inventory = [];
                sales = [];
                orders = [];
                purchases = [];
                showLogin();
            }
        });
    </script>

    <script>
        // Global variables
        let currentSection = 'dashboard';
        let currentCompany = null;
        let companies = [];
        let inventory = [];
        let sales = [];
        let orders = [];
        let purchases = [];

        // Authentication Functions
        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            showLoading(true);
            try {
                await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                showNotification('Login successful!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function signup(email, password, name) {
            showLoading(true);
            try {
                const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                
                // Create user profile
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'users'), {
                    uid: userCredential.user.uid,
                    email: email,
                    name: name,
                    createdAt: window.firebase.serverTimestamp()
                });
                
                showNotification('Account created successfully!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showLoading(true);
                try {
                    // Clear localStorage
                    localStorage.removeItem('selectedCompanyId');
                    // Sign out
                    await window.firebase.signOut(window.firebase.auth);
                    // Clear global variables
                    currentCompany = null;
                    companies = [];
                    inventory = [];
                    sales = [];
                    orders = [];
                    purchases = [];
                    showNotification('Logged out successfully', 'success');
                } catch (error) {
                    showNotification(error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }



        function showSignup() {
            const modalBody = `
                <form onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" id="signupName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="signupPassword" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                </form>
            `;
            showModal('Create Account', modalBody);
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            await signup(email, password, name);
            closeModal();
        }

        // Load user data
        async function loadUserData() {
            if (!window.currentUser) return;
            
            // Update user display
            const userEmail = window.currentUser.email;
            document.getElementById('userDisplay').textContent = `Welcome, ${userEmail}`;
            document.getElementById('userAvatar').textContent = userEmail.charAt(0).toUpperCase();
            
            // Set profile email if element exists
            const profileEmailElement = document.getElementById('profileEmail');
            if (profileEmailElement) {
                profileEmailElement.value = userEmail;
            }
            
            // Load companies first
            await loadCompanies();
            
            // Load dashboard data after companies are loaded
            // This ensures currentCompany is set
            if (currentCompany) {
                await loadDashboardData();
            }
        }

        // Company Management
        async function loadCompanies() {
            if (!window.currentUser) {
                console.error('No user logged in');
                return;
            }
            
            try {
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'companies'),
                    window.firebase.where('userId', '==', window.currentUser.uid)
                );
                
                const querySnapshot = await window.firebase.getDocs(q);
                companies = [];
                
                querySnapshot.forEach((doc) => {
                    companies.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Loaded companies:', companies.length);
                
                updateCompanySelector();
                updateCompaniesTable();
                
                // Restore previously selected company from localStorage or select first
                const savedCompanyId = localStorage.getItem('selectedCompanyId');
                if (savedCompanyId && companies.find(c => c.id === savedCompanyId)) {
                    currentCompany = savedCompanyId;
                } else if (companies.length > 0) {
                    currentCompany = companies[0].id;
                }
                
                if (currentCompany) {
                    document.getElementById('companySelect').value = currentCompany;
                    // Save to localStorage for persistence
                    localStorage.setItem('selectedCompanyId', currentCompany);
                    console.log('Selected company:', currentCompany);
                }
            } catch (error) {
                console.error('Error loading companies:', error);
                showNotification('Error loading companies: ' + error.message, 'error');
            }
        }

        function updateCompanySelector() {
            const select = document.getElementById('companySelect');
            select.innerHTML = companies.map(company => 
                `<option value="${company.id}">${company.name}</option>`
            ).join('');
            
            if (companies.length === 0) {
                select.innerHTML = '<option value="">No companies - Add one in Settings</option>';
            }
        }

        function updateCompaniesTable() {
            const tbody = document.getElementById('companiesTable');
            
            if (companies.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">No companies found</td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = companies.map(company => `
                <tr>
                    <td>${company.name}</td>
                    <td>${company.industry}</td>
                    <td>${new Date(company.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 0.5rem; font-size: 0.9rem;" 
                                onclick="deleteCompany('${company.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addCompany() {
            const name = document.getElementById('newCompanyName').value;
            const industry = document.getElementById('newCompanyIndustry').value;
            
            if (!name) {
                showNotification('Please enter a company name', 'error');
                return;
            }
            
            showLoading(true);
            try {
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'companies'), {
                    name: name,
                    industry: industry,
                    userId: window.currentUser.uid,
                    createdAt: window.firebase.serverTimestamp()
                });
                
                document.getElementById('newCompanyName').value = '';
                await loadCompanies();
                showNotification('Company added successfully', 'success');
            } catch (error) {
                showNotification('Error adding company: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteCompany(companyId) {
            if (!confirm('Are you sure you want to delete this company? All related data will be lost.')) {
                return;
            }
            
            showLoading(true);
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'companies', companyId));
                await loadCompanies();
                showNotification('Company deleted successfully', 'success');
            } catch (error) {
                showNotification('Error deleting company: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function switchCompany() {
            currentCompany = document.getElementById('companySelect').value;
            if (currentCompany) {
                // Save to localStorage for persistence
                localStorage.setItem('selectedCompanyId', currentCompany);
                loadDashboardData();
                showNotification('Switched company', 'success');
            }
        }

        // Dashboard Data
        async function loadDashboardData() {
            if (!currentCompany) {
                console.log('No company selected, cannot load dashboard data');
                showNotification('Please select or create a company first', 'warning');
                if (companies.length === 0) {
                    showSection('settings', document.querySelector('.nav-link[onclick*="settings"]'));
                }
                return;
            }
            
            console.log('Loading dashboard data for company:', currentCompany);
            
            try {
                await Promise.all([
                    loadInventory(),
                    loadSales(),
                    loadOrders(),
                    loadPurchases()
                ]);
                
                updateDashboardStats();
                updateDashboardChart();
                updateRecentActivities();
                console.log('Dashboard data loaded successfully');
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Error loading data: ' + error.message, 'error');
            }
        }


        function updateDashboardStats() {
    // Calculate total inventory value
            const totalValue = inventory.reduce((sum, item) => 
                sum + (item.quantity * item.unitPrice), 0);
            document.getElementById('totalInventoryValue').textContent = `‚Ç±${totalValue.toFixed(2)}`;
            
            // Total items
            const totalItems = inventory.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('totalItems').textContent = totalItems;
            
            // Low stock items (less than 10)
            const lowStock = inventory.filter(item => item.quantity < 10).length;
            document.getElementById('lowStockItems').textContent = lowStock;
            
            // Pending orders
            const pending = orders.filter(order => order.status === 'Pending').length;
            document.getElementById('pendingOrders').textContent = pending;

            // Get today's date (start of day)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Get current month and year
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Calculate Today's Sales
            const todaySales = sales.filter(sale => {
                let saleDate;
                
                // Handle different date formats
                if (sale.invoiceDate) {
                    // If invoiceDate is a string in YYYY-MM-DD format
                    saleDate = new Date(sale.invoiceDate);
                } else if (sale.date && sale.date.seconds) {
                    // If date is a Firestore timestamp
                    saleDate = new Date(sale.date.seconds * 1000);
                } else if (sale.date) {
                    // If date is already a Date object or timestamp
                    saleDate = new Date(sale.date);
                } else {
                    // If no valid date found, exclude from today's sales
                    return false;
                }
                
                saleDate.setHours(0, 0, 0, 0);
                return saleDate.getTime() === today.getTime();
            }).reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            
            document.getElementById('todaysSalesDashboard').textContent = `‚Ç±${todaySales.toFixed(2)}`;

            // Calculate Monthly Revenue
            const monthlySales = sales.filter(sale => {
                let saleDate;
                
                // Handle different date formats
                if (sale.invoiceDate) {
                    // If invoiceDate is a string in YYYY-MM-DD format
                    saleDate = new Date(sale.invoiceDate);
                } else if (sale.date && sale.date.seconds) {
                    // If date is a Firestore timestamp
                    saleDate = new Date(sale.date.seconds * 1000);
                } else if (sale.date) {
                    // If date is already a Date object or timestamp
                    saleDate = new Date(sale.date);
                } else {
                    // If no valid date found, exclude from monthly sales
                    return false;
                }
                
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            }).reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            
            document.getElementById('monthlyRevenue').textContent = `‚Ç±${monthlySales.toFixed(2)}`;

            // Top selling category
            const categorySales = {};
            sales.forEach(sale => {
                const item = inventory.find(i => i.sku === sale.itemSKU);
                if (item) {
                    categorySales[item.category] = (categorySales[item.category] || 0) + (sale.total || sale.amount || 0);
                }
            });
            const topCategory = Object.entries(categorySales).sort(([,a], [,b]) => b - a)[0];
            document.getElementById('topCategory').textContent = topCategory ? topCategory[0] : '-';

            // Average order value
            const avgOrderValue = sales.length > 0 ? monthlySales / sales.length : 0;
            document.getElementById('avgOrderValue').textContent = `‚Ç±${avgOrderValue.toFixed(2)}`;

            // Stock turnover rate
            const avgInventoryValue = totalValue;
            const turnoverRate = avgInventoryValue > 0 ? (monthlySales / avgInventoryValue) * 100 : 0;
            document.getElementById('turnoverRate').textContent = `${turnoverRate.toFixed(1)}%`;
        }



        // Inventory Management
        async function loadInventory() {
            if (!currentCompany) {
                console.log('No company selected for inventory load');
                return;
            }
            
            try {
                console.log('Loading inventory for company:', currentCompany);
                
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'inventory'),
                    window.firebase.where('companyId', '==', currentCompany)
                );
                
                const querySnapshot = await window.firebase.getDocs(q);
                inventory = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    inventory.push({ id: doc.id, ...data });
                });
                
                console.log('Loaded inventory items:', inventory.length);
                
                updateInventoryTable();
                updateInventoryStats();
                updateForecastCategories(); // Add this line
            } catch (error) {
                console.error('Error loading inventory:', error);
                showNotification('Error loading inventory: ' + error.message, 'error');
            }
        }


        function updateInventoryTable() {
            const tbody = document.getElementById('inventoryTable');
            
            if (inventory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <p>No inventory items found</p>
                            <button class="btn btn-primary" onclick="showAddInventoryModal()" style="margin-top: 1rem;">Add First Item</button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = inventory.map(item => `
                <tr>
                    <td>${item.sku}</td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.quantity}</td>
                    <td>$${item.unitPrice.toFixed(2)}</td>
                    <td>$${(item.quantity * item.unitPrice).toFixed(2)}</td>
                    <td>${new Date(item.updatedAt?.seconds * 1000 || Date.now()).toLocaleDateString()} ${new Date(item.updatedAt?.seconds * 1000 || Date.now()).toLocaleTimeString()}</td>
                    <td>
                        <span class="stat-change ${item.quantity < (item.lowStockThreshold || 10) ? 'negative' : 'positive'}">
                            ${item.quantity < (item.lowStockThreshold || 10) ? 'Low Stock' : 'In Stock'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.9rem;" 
                                onclick="editInventoryItem('${item.id}')">Edit</button>
                    </td>
                </tr>

            `).join('');
        }


        function updateInventoryStats() {
            const totalValue = inventory.reduce((sum, item) => 
                sum + (item.quantity * item.unitPrice), 0);
            document.getElementById('totalStockValue').textContent = `‚Ç±${totalValue.toFixed(2)}`;
            document.getElementById('totalSKUs').textContent = inventory.length;
            
            const lowStock = inventory.filter(item => item.quantity < 10).length;
            document.getElementById('lowStockAlert').textContent = lowStock;
            
            const outOfStock = inventory.filter(item => item.quantity === 0).length;
            document.getElementById('outOfStock').textContent = outOfStock;
        }

        function showAddInventoryModal() {
            const modalBody = `
                <form onsubmit="handleAddInventory(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-input" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">SKU</label>
                            <input type="text" class="form-input" id="itemSKU" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-input" id="itemCategory" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="itemQuantity" required min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit Price</label>
                            <input type="number" class="form-input" id="itemPrice" required step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-input" id="itemLocation" placeholder="Warehouse location">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Item</button>
                    </div>
                </form>
            `;
            showModal('Add Inventory Item', modalBody);
        }

        async function handleAddInventory(e) {
            e.preventDefault();
            
            if (!currentCompany) {
                showNotification('Please select a company first', 'error');
                return;
            }
            
            const itemData = {
                name: document.getElementById('itemName').value,
                sku: document.getElementById('itemSKU').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                unitPrice: parseFloat(document.getElementById('itemPrice').value),
                location: document.getElementById('itemLocation').value,
                lowStockThreshold: parseInt(document.getElementById('itemLowStockThreshold').value) || 10,
                companyId: currentCompany,
                createdAt: window.firebase.serverTimestamp(),
                updatedAt: window.firebase.serverTimestamp()
            };

            
            showLoading(true);
            try {
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'inventory'), itemData);
                closeModal();
                await loadInventory();
                showNotification('Item added successfully', 'success');
            } catch (error) {
                showNotification('Error adding item: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Sales Management
        async function loadSales() {
            if (!currentCompany) return;
            
            try {
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'sales'),
                    window.firebase.where('companyId', '==', currentCompany),
                    window.firebase.orderBy('createdAt', 'desc'), // Changed from 'date' to 'createdAt'
                    window.firebase.limit(50)
                );
                
                const querySnapshot = await window.firebase.getDocs(q);
                sales = [];
                
                querySnapshot.forEach((doc) => {
                    sales.push({ id: doc.id, ...doc.data() });
                });
                
                updateSalesTable();
                updateSalesStats();
            } catch (error) {
                console.error('Error loading sales:', error);
            }
        }


        // In your main <script> tag
        function updateSalesTable() {
            const tbody = document.getElementById('salesTable');
            
            if (sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-icon">üí∞</div>
                            <p>No sales transactions found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = sales.map(sale => {
                // Use the new field name, OR (||) the old field name as a fallback
                const invoiceDate = sale.invoiceDate || (sale.date ? new Date(sale.date.seconds * 1000).toLocaleDateString() : 'N/A');
                const invoiceNo = sale.invoiceNo || sale.transactionId || 'N/A';
                const itemSKU = sale.itemSKU || sale.sku || 'N/A';
                const customerName = sale.customerName || sale.customer || 'N/A';
                const itemName = sale.itemName || 'N/A';
                const unitPrice = sale.unitPrice || sale.price || 0;
                const quantity = sale.quantity || 0;
                const total = sale.total || sale.amount || 0;
                const createdAt = sale.createdAt ? new Date(sale.createdAt.seconds * 1000).toLocaleString() : (sale.date ? new Date(sale.date.seconds * 1000).toLocaleString() : 'N/A');

                return `
                    <tr>
                        <td>${invoiceDate}</td>
                        <td>${invoiceNo}</td>
                        <td>${itemSKU}</td>
                        <td>${customerName}</td>
                        <td>${itemName}</td>
                        <td>‚Ç±${unitPrice.toFixed(2)}</td>
                        <td>${quantity}</td>
                        <td>‚Ç±${total.toFixed(2)}</td>
                        <td>${createdAt}</td>
                    </tr>
                `;
            }).join('');
        }



        // Replace the existing updateSalesStats function with this:
        function updateSalesStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Debug: Log all sales to see their dates
            console.log("All sales:", sales);
            
            const todaySales = sales.filter(sale => {
                let saleDate;
                
                // Handle different date formats
                if (sale.invoiceDate) {
                    // If invoiceDate is a string in YYYY-MM-DD format
                    saleDate = new Date(sale.invoiceDate);
                } else if (sale.date && sale.date.seconds) {
                    // If date is a Firestore timestamp
                    saleDate = new Date(sale.date.seconds * 1000);
                } else if (sale.date) {
                    // If date is already a Date object or timestamp
                    saleDate = new Date(sale.date);
                } else {
                    // If no valid date found, exclude from today's sales
                    return false;
                }
                
                saleDate.setHours(0, 0, 0, 0);
                
                // Debug: Log each sale's date comparison
                console.log(`Sale date: ${saleDate.toISOString()}, Today: ${today.toISOString()}, Match: ${saleDate.getTime() === today.getTime()}`);
                
                return saleDate.getTime() === today.getTime();
            });
            
            // Debug: Log today's sales
            console.log("Today's sales:", todaySales);
            
            // Calculate today's stats
            const todayTotal = todaySales.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            const todayUnits = todaySales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            const avgValue = todaySales.length > 0 ? todayTotal / todaySales.length : 0;
            
            // Calculate all-time stats
            const allTimeTotal = sales.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            const allTimeUnits = sales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            const allTimeAvgValue = sales.length > 0 ? allTimeTotal / sales.length : 0;
            
            // Update UI - use today's stats if available, otherwise use all-time stats
            document.getElementById('todaysSales').textContent = `‚Ç±${todayTotal > 0 ? todayTotal.toFixed(2) : allTimeTotal.toFixed(2)}`;
            document.getElementById('unitsSoldToday').textContent = todayUnits > 0 ? todayUnits : allTimeUnits;
            document.getElementById('avgOrderValue').textContent = `‚Ç±${todayTotal > 0 ? avgValue.toFixed(2) : allTimeAvgValue.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = sales.length;
        }




        function showAddSaleModal() {
            const modalBody = `
                <form onsubmit="handleAddSale(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Invoice Date</label>
                            <input type="date" class="form-input" id="saleInvoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Invoice No.</label>
                            <input type="text" class="form-input" id="saleInvoiceNo" required placeholder="INV-001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-input" id="saleCustomer" required placeholder="Customer name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Item (SKU)</label>
                            <select class="form-select" id="saleSKU" onchange="updateSaleItemDetails()" required>
                                <option value="">Select Item</option>
                                ${inventory.map(item => 
                                    `<option value="${item.sku}" data-name="${item.name}" data-price="${item.unitPrice}">${item.sku} - ${item.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-input" id="saleItemName" readonly placeholder="Auto-filled">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="saleQuantity" required min="1" onchange="calculateSaleAmount()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-input" id="salePrice" required step="0.01" min="0" onchange="calculateSaleAmount()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="saleAmount" readonly step="0.01">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Record Sale</button>
                    </div>
                </form>
            `;
            showModal('Record Sales Transaction', modalBody);
        }

        function updateSaleItemDetails() {
            const select = document.getElementById('saleSKU');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('saleItemName').value = selectedOption.dataset.name;
                document.getElementById('salePrice').value = selectedOption.dataset.price;
                calculateSaleAmount();
            }
        }

        function calculateSaleAmount() {
            const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
            const price = parseFloat(document.getElementById('salePrice').value) || 0;
            document.getElementById('saleAmount').value = (quantity * price).toFixed(2);
        }

        async function handleAddSale(e) {
            e.preventDefault();
            
            if (!currentCompany) {
                showNotification('Please select a company first', 'error');
                return;
            }
            
            const select = document.getElementById('saleSKU');
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const price = parseFloat(document.getElementById('salePrice').value);
            const amount = parseFloat(document.getElementById('saleAmount').value);
            const invoiceDate = document.getElementById('saleInvoiceDate').value;
            
            const saleData = {
                // Use the standardized field names
                invoiceNo: document.getElementById('saleInvoiceNo').value,
                invoiceDate: invoiceDate, // String from the date input
                customerName: document.getElementById('saleCustomer').value,
                itemSKU: select.value,
                itemName: document.getElementById('saleItemName').value,
                
                // CRITICAL: Ensure numbers are saved as Number type
                unitPrice: price, 
                quantity: quantity,
                total: amount, // Calculated from numbers
                
                // BEST PRACTICE: Use serverTimestamp for accuracy
                createdAt: window.firebase.serverTimestamp(),
                updatedAt: window.firebase.serverTimestamp(), // Good practice to add an update timestamp
                
                // Required for company-specific data
                companyId: currentCompany 
            };
            
            showLoading(true);
            try {
                // Add sale record
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'sales'), saleData);
                
                // Update inventory
                const inventoryItem = inventory.find(item => item.sku === select.value);
                if (inventoryItem) {
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.firebase.db, 'inventory', inventoryItem.id),
                        {
                            quantity: inventoryItem.quantity - quantity,
                            updatedAt: window.firebase.serverTimestamp()
                        }
                    );
                }
                
                closeModal();
                await loadSales();
                await loadInventory();
                await updateSalesStats();
                await updateDashboardStats();
                showNotification('Sale recorded successfully', 'success');
            } catch (error) {
                showNotification('Error recording sale: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }


        // Orders Management
        async function loadOrders() {
            if (!currentCompany) return;
            
            try {
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'orders'),
                    window.firebase.where('companyId', '==', currentCompany),
                    window.firebase.orderBy('orderDate', 'desc')
                );
                
                const querySnapshot = await window.firebase.getDocs(q);
                orders = [];
                
                querySnapshot.forEach((doc) => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                
                updateOrdersTable();
                updateOrdersStats();
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function updateOrdersTable() {
            const tbody = document.getElementById('ordersTable');
            
            if (orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">üìù</div>
                            <p>No orders found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.orderId}</td>
                    <td>${new Date(order.orderDate?.seconds * 1000 || Date.now()).toLocaleDateString()}</td>
                    <td>${order.customer}</td>
                    <td>${order.items} items</td>
                    <td>‚Ç±${order.total.toFixed(2)}</td>
                    <td><span class="stat-change ${order.status === 'Pending' ? 'negative' : 'positive'}">${order.status}</span></td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.9rem;" 
                                onclick="updateOrderStatus('${order.id}')">Update</button>
                    </td>
                </tr>
            `).join('');
        }

        function searchOrders() {
            const searchTerm = document.getElementById('ordersSearch').value.toLowerCase();
            const startDate = document.getElementById('ordersStartDate').value;
            const endDate = document.getElementById('ordersEndDate').value;
            
            let filtered = orders;
            
            if (searchTerm) {
                filtered = filtered.filter(order => 
                    order.orderId.toLowerCase().includes(searchTerm) || 
                    order.customer.toLowerCase().includes(searchTerm)
                );
            }
            
            if (startDate) {
                filtered = filtered.filter(order => {
                    const orderDate = new Date(order.orderDate?.seconds * 1000 || 0);
                    return orderDate >= new Date(startDate);
                });
            }
            
            if (endDate) {
                filtered = filtered.filter(order => {
                    const orderDate = new Date(order.orderDate?.seconds * 1000 || 0);
                    return orderDate <= new Date(endDate + 'T23:59:59');
                });
            }
            
            // Update table with filtered results
            const tbody = document.getElementById('ordersTable');
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">No orders found matching your search</td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(order => `
                    <tr>
                        <td>${order.orderId}</td>
                        <td>${new Date(order.orderDate?.seconds * 1000 || Date.now()).toLocaleDateString()}</td>
                        <td>${order.customer}</td>
                        <td>${order.items} items</td>
                        <td>‚Ç±${order.total.toFixed(2)}</td>
                        <td><span class="stat-change ${order.status === 'Pending' ? 'negative' : 'positive'}">${order.status}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.9rem;" 
                                    onclick="updateOrderStatus('${order.id}')">Update</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            showNotification(`Found ${filtered.length} orders`, 'success');
        }


        function updateOrdersStats() {
            document.getElementById('totalOrders').textContent = orders.length;
            
            const pending = orders.filter(order => order.status === 'Pending').length;
            document.getElementById('pendingOrdersCount').textContent = pending;
            
            const completed = orders.filter(order => order.status === 'Completed').length;
            document.getElementById('completedOrders').textContent = completed;
            
            const totalValue = orders.reduce((sum, order) => sum + order.total, 0);
            document.getElementById('totalOrderValue').textContent = `‚Ç±${totalValue.toFixed(2)}`;
        }

        function showNewOrderModal() {
            const modalBody = `
                <form onsubmit="handleNewOrder(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Ship Date</label>
                            <input type="date" class="form-input" id="orderShipDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">SO No.</label>
                            <input type="text" class="form-input" id="orderSONo" required placeholder="SO-001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-input" id="orderCustomer" required placeholder="Customer name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Item (SKU)</label>
                            <select class="form-select" id="orderSKU" onchange="updateOrderItemDetails()" required>
                                <option value="">Select Item</option>
                                ${inventory.map(item => 
                                    `<option value="${item.sku}" data-name="${item.name}" data-price="${item.unitPrice}">${item.sku} - ${item.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-input" id="orderItemName" readonly placeholder="Auto-filled">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="orderQuantity" required min="1" onchange="calculateOrderAmount()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-input" id="orderPrice" required step="0.01" min="0" onchange="calculateOrderAmount()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="orderAmount" readonly step="0.01">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Order</button>
                    </div>
                </form>
            `;
            showModal('New Sales Order', modalBody);
        }

        function updateOrderItemDetails() {
            const select = document.getElementById('orderSKU');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('orderItemName').value = selectedOption.dataset.name;
                document.getElementById('orderPrice').value = selectedOption.dataset.price;
                calculateOrderAmount();
            }
        }

        function calculateOrderAmount() {
            const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
            const price = parseFloat(document.getElementById('orderPrice').value) || 0;
            document.getElementById('orderAmount').value = (quantity * price).toFixed(2);
        }

        async function handleNewOrder(e) {
            e.preventDefault();
            
            if (!currentCompany) {
                showNotification('Please select a company first', 'error');
                return;
            }
            
            const orderData = {
                shipDate: document.getElementById('orderShipDate').value,
                soNo: document.getElementById('orderSONo').value,
                customerName: document.getElementById('orderCustomer').value,
                sku: document.getElementById('orderSKU').value,
                itemName: document.getElementById('orderItemName').value,
                quantity: parseInt(document.getElementById('orderQuantity').value),
                price: parseFloat(document.getElementById('orderPrice').value),
                amount: parseFloat(document.getElementById('orderAmount').value = (quantity * price)).toFixed(2),
                status: 'Pending',
                companyId: currentCompany,
                createdAt: window.firebase.serverTimestamp(),
                
                // Legacy fields for compatibility
                orderId: document.getElementById('orderSONo').value,
                customer: document.getElementById('orderCustomer').value,
                items: 1,
                total: parseFloat(document.getElementById('orderAmount').value),
                deliveryDate: document.getElementById('orderShipDate').value,
                orderDate: window.firebase.serverTimestamp()
            };
            
            showLoading(true);
            try {
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'orders'), orderData);
                closeModal();
                await loadOrders();
                showNotification('Order created successfully', 'success');
            } catch (error) {
                showNotification('Error creating order: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Purchase Management
        async function loadPurchases() {
            if (!currentCompany) {
                console.log('No company selected for purchases load');
                return;
            }
            
            try {
                console.log('Loading purchases for company:', currentCompany);
                
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'purchases'),
                    window.firebase.where('companyId', '==', currentCompany),
                    window.firebase.orderBy('date', 'desc')
                );
                
                const querySnapshot = await window.firebase.getDocs(q);
                purchases = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    purchases.push({ id: doc.id, ...data });
                });
                
                console.log('Loaded purchases:', purchases.length);
                
                updatePurchaseTable();
                updatePurchaseStats();
            } catch (error) {
                console.error('Error loading purchases:', error);
                showNotification('Error loading purchases: ' + error.message, 'error');
            }
        }

        function updatePurchaseTable() {
            const tbody = document.getElementById('purchaseTable');
            
            if (purchases.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-icon">üõí</div>
                            <p>No purchase records found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = purchases.map(purchase => `
                <tr>
                    <td>${purchase.poNo || purchase.poNumber}</td>
                    <td>${new Date(purchase.purchaseDate || purchase.date?.seconds * 1000).toLocaleDateString()}</td>
                    <td>${purchase.supplierName || purchase.supplier}</td>
                    <td>${purchase.sku}</td>
                    <td>${purchase.itemName}</td>
                    <td>${purchase.quantity}</td>
                    <td>‚Ç±${purchase.price}</td>
                    <td>‚Ç±${purchase.amount || purchase.totalCost}</td>
                    <td><span class="stat-change ${purchase.status === 'Pending' ? 'negative' : 'positive'}">${purchase.status}</span></td>
                </tr>
            `).join('');
        }

        function searchPurchases() {
            const searchTerm = document.getElementById('purchaseSearch').value.toLowerCase();
            const startDate = document.getElementById('purchaseStartDate').value;
            const endDate = document.getElementById('purchaseEndDate').value;
            
            let filtered = purchases;
            
            if (searchTerm) {
                filtered = filtered.filter(purchase => 
                    purchase.itemName.toLowerCase().includes(searchTerm) || 
                    purchase.sku.toLowerCase().includes(searchTerm) ||
                    (purchase.supplierName || purchase.supplier).toLowerCase().includes(searchTerm)
                );
            }
            
            if (startDate) {
                filtered = filtered.filter(purchase => {
                    const purchaseDate = new Date(purchase.purchaseDate || purchase.date?.seconds * 1000 || 0);
                    return purchaseDate >= new Date(startDate);
                });
            }
            
            if (endDate) {
                filtered = filtered.filter(purchase => {
                    const purchaseDate = new Date(purchase.purchaseDate || purchase.date?.seconds * 1000 || 0);
                    return purchaseDate <= new Date(endDate + 'T23:59:59');
                });
            }
            
            // Update table with filtered results
            const tbody = document.getElementById('purchaseTable');
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">No purchase records found matching your search</td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(purchase => `
                    <tr>
                        <td>${purchase.poNo || purchase.poNumber}</td>
                        <td>${new Date(purchase.purchaseDate || purchase.date?.seconds * 1000).toLocaleDateString()}</td>
                        <td>${purchase.supplierName || purchase.supplier}</td>
                        <td>${purchase.sku}</td>
                        <td>${purchase.itemName}</td>
                        <td>${purchase.quantity}</td>
                        <td>$${purchase.price}</td>
                        <td>$${purchase.amount || purchase.totalCost}</td>
                        <td><span class="stat-change ${purchase.status === 'Pending' ? 'negative' : 'positive'}">${purchase.status}</span></td>
                    </tr>
                `).join('');
            }
            
            showNotification(`Found ${filtered.length} purchase records`, 'success');
        }



        function updatePurchaseTable() {
            const tbody = document.getElementById('purchaseTable');
            
            if (purchases.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">üõí</div>
                            <p>No purchase records found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = purchases.map(purchase => `
                <tr>
                    <td>${purchase.poNumber}</td>
                    <td>${purchase.supplier}</td>
                    <td>${purchase.items} units</td>
                    <td>${purchase.totalCost.toFixed(2)}</td>
                    <td>${new Date(purchase.date?.seconds * 1000 || Date.now()).toLocaleDateString()}</td>
                    <td><span class="stat-change ${purchase.status === 'Pending' ? 'negative' : 'positive'}">${purchase.status}</span></td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.9rem;" 
                                onclick="viewPurchase('${purchase.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePurchaseStats() {
            const totalPurchases = purchases.reduce((sum, p) => sum + p.totalCost, 0);
            document.getElementById('totalPurchases').textContent = `‚Ç±${totalPurchases.toFixed(2)}`;
            
            const activePOs = purchases.filter(p => p.status === 'Pending').length;
            document.getElementById('activePOs').textContent = activePOs;
            
            const suppliers = [...new Set(purchases.map(p => p.supplier))].length;
            document.getElementById('suppliersCount').textContent = suppliers;
            
            const totalItems = purchases.reduce((sum, p) => sum + p.items, 0);
            document.getElementById('itemsPurchased').textContent = totalItems;
        }

        function showAddPurchaseModal() {
            const modalBody = `
                <form onsubmit="handleAddPurchase(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Purchase Date</label>
                            <input type="date" class="form-input" id="purchaseDate" required value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">PO No.</label>
                            <input type="text" class="form-input" id="purchasePONo" required placeholder="PO-001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Supplier Name</label>
                            <input type="text" class="form-input" id="purchaseSupplier" required placeholder="Supplier name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">SKU</label>
                            <input type="text" class="form-input" id="purchaseSKU" required placeholder="Item SKU">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-input" id="purchaseItemName" required placeholder="Item name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-input" id="purchaseCategory" required placeholder="Category">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="purchaseQuantity" required min="1" onchange="calculatePurchaseAmount()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-input" id="purchasePrice" required step="0.01" min="0" onchange="calculatePurchaseAmount()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="purchaseAmount" readonly step="0.01">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Record Purchase</button>
                    </div>
                </form>
            `;
            showModal('New Purchase Order', modalBody);
        }


        async function handleAddPurchase(e) {
            e.preventDefault();
            
            if (!currentCompany) {
                showNotification('Please select a company first', 'error');
                return;
            }

            try {
                const quantity = parseInt(document.getElementById('purchaseQuantity').value);
                const price = parseFloat(document.getElementById('purchasePrice').value);
                const amount = parseFloat(document.getElementById('purchaseAmount').value = (quantity * price).toFixed(2););
                const sku = document.getElementById('purchaseSKU').value;
                const itemName = document.getElementById('purchaseItemName').value;
                const category = document.getElementById('purchaseCategory').value;

                // Validate inputs
                if (!sku || !itemName || !category || !quantity || !price) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                if (quantity <= 0 || price <= 0) {
                    showNotification('Quantity and price must be greater than 0', 'error');
                    return;
                }

                const purchaseData = {
                    purchaseDate: document.getElementById('purchaseDate').value,
                    poNo: document.getElementById('purchasePONo').value,
                    supplierName: document.getElementById('purchaseSupplier').value,
                    sku: sku,
                    itemName: itemName,
                    category: category,
                    quantity: quantity,
                    price: price,
                    amount: amount,
                    status: 'Received',
                    companyId: currentCompany,
                    createdAt: window.firebase.serverTimestamp(),
                    
                    // Legacy fields for compatibility
                    poNumber: document.getElementById('purchasePONo').value,
                    supplier: document.getElementById('purchaseSupplier').value,
                    items: quantity,
                    totalCost: amount,
                    date: window.firebase.serverTimestamp()
                };
                
                showLoading(true);
                
                // Add purchase record
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'purchases'), purchaseData);
                
                // Check if item exists in inventory
                const existingItem = inventory.find(item => item.sku === sku);
                
                if (existingItem) {
                    // Update existing inventory
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.firebase.db, 'inventory', existingItem.id),
                        {
                            quantity: existingItem.quantity + quantity,
                            unitPrice: price,
                            updatedAt: window.firebase.serverTimestamp()
                        }
                    );
                } else {
                    // Add new inventory item
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'inventory'), {
                        sku: sku,
                        name: itemName,
                        category: category,
                        quantity: quantity,
                        unitPrice: price,
                        location: '',
                        companyId: currentCompany,
                        createdAt: window.firebase.serverTimestamp(),
                        updatedAt: window.firebase.serverTimestamp()
                    });
                }
                
                closeModal();
                await loadPurchases();
                await loadInventory();
                showNotification('Purchase recorded successfully', 'success');
            } catch (error) {
                console.error('Error in handleAddPurchase:', error);
                showNotification('Error recording purchase: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }


        // Section Navigation
        function showSection(sectionId, linkElement) {
            // Check if company is selected
            if (!currentCompany && sectionId !== 'settings') {
                showNotification('Please select or create a company first', 'warning');
                // Redirect to settings
                showSection('settings', document.querySelector('.nav-link[onclick*="settings"]'));
                return;
            }
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (linkElement) {
                linkElement.classList.add('active');
            }
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'forecast': 'Stock Forecast',
                'inventory': 'Inventory Management',
                'sales': 'Sales Management',
                'sales-order': 'Sales Orders',
                'purchase': 'Purchase Management',
                'settings': 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId];
            currentSection = sectionId;
            
            // Load section-specific data with company check
            if (currentCompany) {
                console.log(`Loading data for section: ${sectionId}, company: ${currentCompany}`);
                
                switch(sectionId) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'inventory':
                        loadInventory();
                        break;
                    case 'sales':
                        loadSales();
                        break;
                    case 'sales-order':
                        loadOrders();
                        break;
                    case 'purchase':
                        loadPurchases();
                        break;
                }
            }
        }

        // Utility Functions
        function showModal(title, body) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = 'notification show ' + type;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        // Export Functions
        function exportCSV(type) {
            let data = [];
            let filename = '';
            
            switch(type) {
                case 'inventory':
                    data = inventory;
                    filename = 'inventory';
                    break;
                case 'sales':
                    data = sales;
                    filename = 'sales';
                    break;
                case 'orders':
                    data = orders;
                    filename = 'orders';
                    break;
                case 'purchase':
                    data = purchases;
                    filename = 'purchases';
                    break;
            }
            
            if (data.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            // Convert to CSV
            const headers = Object.keys(data[0]).filter(key => key !== 'id' && key !== 'companyId');
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const value = row[header];
                    if (value?.seconds) {
                        return new Date(value.seconds * 1000).toISOString();
                    }
                    return value || '';
                }).join(','))
            ].join('\n');
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('Data exported successfully', 'success');
        }

        // Import CSV Functions
        async function importCSV(type) {
            const fileInput = document.getElementById(type + 'Import');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file', 'warning');
                return;
            }
            
            if (!currentCompany) {
                showNotification('Please select a company first', 'error');
                return;
            }
            
            showLoading(true);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    
                    if (lines.length < 2) {
                        showNotification('CSV file is empty or invalid', 'error');
                        showLoading(false);
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim());
                    let successCount = 0;
                    let errorCount = 0;
                    const newRecords = []; // <<< NEW: Array to hold records in memory

                    // Process based on type
                    for (let i = 1; i < lines.length; i++) {
                        const data = parseCSVLine(lines[i]);
                        
                        if (data.length !== headers.length) {
                            errorCount++;
                            continue;
                        }
                        
                        const item = {};
                        headers.forEach((header, index) => {
                            const value = data[index].trim();
                            // Convert numeric fields
                            if (['quantity', 'items', 'unitPrice', 'total', 'totalCost'].includes(header)) {
                                item[header] = parseFloat(value) || 0;
                            } else {
                                item[header] = value;
                            }
                        });
                        
                        // Add required fields
                        item.companyId = currentCompany;
                        item.createdAt = window.firebase.serverTimestamp();
                        item.updatedAt = window.firebase.serverTimestamp();
                        
                        try {
                            // Add type-specific fields
                            switch(type) {
                                case 'inventory':
                                    if (!item.sku || !item.name) {
                                        errorCount++;
                                        continue;
                                    }
                                    const existingItem = inventory.find(inv => inv.sku === item.sku);
                                    if (existingItem) {
                                        await window.firebase.updateDoc(
                                            window.firebase.doc(window.firebase.db, 'inventory', existingItem.id),
                                            {
                                                quantity: item.quantity,
                                                unitPrice: item.unitPrice,
                                                updatedAt: window.firebase.serverTimestamp()
                                            }
                                        );
                                        successCount++;
                                        continue;
                                    }
                                    newRecords.push(item); // <<< MODIFIED: Push to array
                                    break;

                                case 'sales':
                                    if (!item.invoiceNo || !item.customerName || !item.itemSKU) {
                                        errorCount++;
                                        continue;
                                    }
                                    const unitPrice = parseFloat(item.unitPrice) || 0;
                                    const quantity = parseInt(item.quantity) || 0;
                                    const total = parseFloat(item.total) || (unitPrice * quantity);

                                    const salesRecord = {
                                        invoiceNo: item.invoiceNo,
                                        invoiceDate: item.invoiceDate || new Date().toISOString().split('T')[0],
                                        customerName: item.customerName,
                                        itemSKU: item.itemSKU,
                                        itemName: item.itemName || 'N/A',
                                        unitPrice: unitPrice,
                                        quantity: quantity,
                                        total: total,
                                        companyId: currentCompany,
                                        createdAt: window.firebase.serverTimestamp(),
                                        updatedAt: window.firebase.serverTimestamp()
                                    };
                                    newRecords.push(salesRecord); // <<< MODIFIED: Push to array
                                    break;
                                    
                                case 'orders':
                                    item.orderId = item.orderId || `ORD-${Date.now()}-${i}`;
                                    item.status = item.status || 'Pending';
                                    item.orderDate = window.firebase.serverTimestamp();
                                    newRecords.push(item); // <<< MODIFIED: Push to array
                                    break;
                                    
                                case 'purchase':
                                    item.poNumber = item.poNumber || `PO-${Date.now()}-${i}`;
                                    item.status = item.status || 'Received';
                                    item.date = window.firebase.serverTimestamp();
                                    newRecords.push(item); // <<< MODIFIED: Push to array
                                    break;
                            }
                            
                            // OLD CODE REMOVED: await window.firebase.addDoc(...) was here
                            successCount++; // Count each processed item as a success
                        } catch (error) {
                            console.error('Error processing row:', error);
                            errorCount++;
                        }
                    }

                    // <<< NEW: After the loop, write all records at once
                    if (newRecords.length > 0) {
                        const batchWrites = newRecords.map(record => 
                            window.firebase.addDoc(window.firebase.collection(window.firebase.db, type), record)
                        );
                        await Promise.all(batchWrites);
                        console.log(`Successfully added ${newRecords.length} new records to Firestore.`);
                    }

                    // <<< NEW: Reload data ONCE after all imports are complete
                    switch(type) {
                        case 'inventory':
                            await loadInventory();
                            break;
                        case 'sales':
                            await loadSales();
                            break;
                        case 'orders':
                            await loadOrders();
                            break;
                        case 'purchase':
                            await loadPurchases();
                            break;
                    }
                    
                    // Clear the file input
                    fileInput.value = '';
                    
                    // Show results
                    const totalProcessed = successCount + errorCount;
                    if (errorCount > 0) {
                        showNotification(`Import completed: ${successCount} successful, ${errorCount} failed out of ${totalProcessed} total.`, 'warning');
                    } else {
                        showNotification(`Successfully imported ${successCount} items.`, 'success');
                    }
                    if (type === 'sales') {
                        updateSalesStats();
                        showNotification(`Successfully imported ${successCount} sales records. Stats updated.`, 'success');
                    }
                    if (type === 'sales') {
                        updateSalesStats();
                        updateDashboardStats(); // Add this line to update dashboard stats as well
                    }
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('Error importing CSV: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            };
            
            reader.onerror = function() {
                showNotification('Error reading file', 'error');
                showLoading(false);
            };
            
            reader.readAsText(file);
        }

        
        // Helper function to parse CSV line handling commas in quotes
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current); // Add the last field
            return result;
        }

        // Forecast Functions
        function generateForecast() {
            const searchTerm = document.getElementById('forecastSearch').value.toLowerCase();
            const selectedCategory = document.getElementById('forecastCategory').value;
            const startDate = document.getElementById('forecastStartDate').value;
            const endDate = document.getElementById('forecastEndDate').value;
            const forecastDays = parseInt(document.getElementById('forecastDays').value);
            
            if (!startDate || !endDate) {
                showNotification('Please select both start and end dates for the forecast period', 'warning');
                return;
            }
            
            showNotification('Generating forecast report...', 'success');
            
            // Filter inventory by search term and category
            let filteredInventory = inventory;
            if (searchTerm) {
                filteredInventory = filteredInventory.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) || 
                    item.sku.toLowerCase().includes(searchTerm)
                );
            }
            
            if (selectedCategory) {
                filteredInventory = filteredInventory.filter(item => item.category === selectedCategory);
            }
            
            // Filter sales by date range and other criteria
            const filteredSales = sales.filter(sale => {
                let saleDate;
                
                // Handle different date formats
                if (sale.invoiceDate) {
                    saleDate = new Date(sale.invoiceDate);
                } else if (sale.date && sale.date.seconds) {
                    saleDate = new Date(sale.date.seconds * 1000);
                } else if (sale.date) {
                    saleDate = new Date(sale.date);
                } else {
                    return false; // Exclude sales without valid dates
                }
                
                // Check if sale is within the selected date range
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); // Include the entire end date
                
                return saleDate >= start && saleDate <= end;
            });
            
            // If no sales data found, use a simple forecast based on current inventory
            if (filteredSales.length === 0) {
                const totalItems = filteredInventory.reduce((sum, item) => sum + item.quantity, 0);
                const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
                const avgDailyConsumption = daysDiff > 0 ? totalItems / daysDiff : 0;
                
                const predictedForecastAmount = Math.floor(avgDailyConsumption * forecastDays);
                const recommendedOrder = Math.floor(predictedForecastAmount * 0.7);
                const currentStockCoverage = totalItems > 0 ? Math.floor(totalItems / avgDailyConsumption) : 0;
                
                // Update UI
                document.getElementById('predictedDemand').textContent = `‚Ç±${predictedForecastAmount.toFixed(2)}`;
                document.getElementById('recommendedOrder').textContent = `${recommendedOrder} units (‚Ç±${recommendedOrderValue.toFixed(2)})`;
                document.getElementById('stockCoverage').textContent = `${currentStockCoverage} days`;
                
                // Update suggested orders table
                updateSuggestedOrdersTable(filteredInventory);
                
                // Update chart
                updateForecastChart({
                    currentStock: totalItems,
                    dailyDemand: avgDailyConsumption,
                    recommendedOrder: recommendedOrder,
                    coverageDays: currentStockCoverage,
                    days: forecastDays
                });
                
                showNotification('Limited sales data. Forecast based on current inventory levels.', 'warning');
                return;
            }
            
            // Calculate sales metrics for forecasting
            const totalSalesValue = filteredSales.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            const totalUnitsSold = filteredSales.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
            
            // Calculate date range in days
            const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
            
            // Calculate daily averages
            const avgDailySales = daysDiff > 0 ? totalSalesValue / daysDiff : 0;
            const avgDailyUnits = daysDiff > 0 ? totalUnitsSold / daysDiff : 0;
            
            // Calculate seasonal trends (simple month-over-month comparison)
            const currentMonth = new Date().getMonth();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            
            const currentMonthSales = filteredSales.filter(sale => {
                let saleDate;
                if (sale.invoiceDate) {
                    saleDate = new Date(sale.invoiceDate);
                } else if (sale.date && sale.date.seconds) {
                    saleDate = new Date(sale.date.seconds * 1000);
                } else if (sale.date) {
                    saleDate = new Date(sale.date);
                } else {
                    return false;
                }
                return saleDate.getMonth() === currentMonth;
            }).reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            
            const lastMonthSales = filteredSales.filter(sale => {
                let saleDate;
                if (sale.invoiceDate) {
                    saleDate = new Date(sale.invoiceDate);
                } else if (sale.date && sale.date.seconds) {
                    saleDate = new Date(sale.date.seconds * 1000);
                } else if (sale.date) {
                    saleDate = new Date(sale.date);
                } else {
                    return false;
                }
                return saleDate.getMonth() === lastMonth;
            }).reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            
            // Calculate growth rate
            const growthRate = lastMonthSales > 0 ? (currentMonthSales - lastMonthSales) / lastMonthSales : 0;
            
            // Apply growth rate to forecast
            const adjustedDailySales = avgDailySales * (1 + growthRate);
            const adjustedDailyUnits = avgDailyUnits * (1 + growthRate);
            
            // Calculate forecast values
            const predictedForecastAmount = Math.floor(adjustedDailySales * forecastDays);
            const predictedUnitsNeeded = Math.floor(adjustedDailyUnits * forecastDays);
            
            // Calculate current stock levels
            const currentStock = filteredInventory.reduce((sum, item) => sum + item.quantity, 0);
            const currentStockValue = filteredInventory.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            
            // Calculate recommended order
            const recommendedOrder = Math.max(0, predictedUnitsNeeded - currentStock);
            const recommendedOrderValue = recommendedOrder * (currentStockValue / currentStock || 0);
            
            // Calculate stock coverage
            const stockCoverage = adjustedDailyUnits > 0 ? Math.floor(currentStock / adjustedDailyUnits) : 0;
            
            // Update UI
            document.getElementById('predictedDemand').textContent = `$${predictedForecastAmount.toFixed(2)}`;
            document.getElementById('recommendedOrder').textContent = `${recommendedOrder} units ($${recommendedOrderValue.toFixed(2)})`;
            document.getElementById('stockCoverage').textContent = `${stockCoverage} days`;
            
            // Update suggested orders table with more detailed information
            updateSuggestedOrdersTableWithDetails(filteredInventory, filteredSales, forecastDays, adjustedDailyUnits);
            
            // Update chart with more detailed data
            updateForecastChart({
                currentStock: currentStock,
                dailyDemand: adjustedDailyUnits,
                recommendedOrder: recommendedOrder,
                coverageDays: stockCoverage,
                days: forecastDays,
                salesData: filteredSales,
                growthRate: growthRate
            });
            
            // Show detailed notification
            const categoryText = selectedCategory || 'all categories';
            const searchInfo = searchTerm ? ` for "${searchTerm}"` : '';
            const growthText = growthRate > 0 ? ` (+${(growthRate * 100).toFixed(1)}% growth)` : growthRate < 0 ? ` (${(growthRate * 100).toFixed(1)}% decline)` : '';
            
            showNotification(
                `${forecastDays}-day forecast generated${searchInfo} for ${categoryText}${growthText}`,
                'success'
            );
        }

        function updateSuggestedOrdersTableWithDetails(items, salesData, forecastDays, dailyDemand) {
            const tbody = document.getElementById('suggestedOrdersTable');
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">No items found matching your search</td>
                    </tr>
                `;
                return;
            }
            
            // Calculate sales velocity for each item
            const itemSales = {};
            salesData.forEach(sale => {
                if (!itemSales[sale.itemSKU]) {
                    itemSales[sale.itemSKU] = {
                        quantity: 0,
                        total: 0,
                        transactions: 0
                    };
                }
                itemSales[sale.itemSKU].quantity += sale.quantity || 0;
                itemSales[sale.itemSKU].total += sale.total || sale.amount || 0;
                itemSales[sale.itemSKU].transactions += 1;
            });
            
            // Generate suggested orders
            const suggestedOrders = items.map(item => {
                const sales = itemSales[item.sku] || { quantity: 0, total: 0, transactions: 0 };
                
                // Calculate days of stock based on current sales velocity
                const dailyUsage = sales.quantity / forecastDays;
                const daysOfStock = dailyUsage > 0 ? item.quantity / dailyUsage : 999;
                
                // Calculate suggested order quantity
                let suggestedOrder = 0;
                let priority = 'Low';
                
                if (daysOfStock < 7) {
                    priority = 'High';
                    suggestedOrder = Math.ceil(dailyUsage * 30 - item.quantity); // Order for 30 days
                } else if (daysOfStock < 14) {
                    priority = 'Medium';
                    suggestedOrder = Math.ceil(dailyUsage * 14 - item.quantity); // Order for 14 days
                }
                
                // Ensure we don't order negative quantities
                suggestedOrder = Math.max(0, suggestedOrder);
                
                // Calculate order value
                const orderValue = suggestedOrder * item.unitPrice;
                
                return {
                    name: item.name,
                    category: item.category,
                    currentStock: item.quantity,
                    salesVelocity: dailyUsage.toFixed(2),
                    daysOfStock: daysOfStock.toFixed(1),
                    suggestedOrder: suggestedOrder,
                    orderValue: orderValue,
                    priority: priority
                };
            });
            
            // Sort by priority (High first) and then by days of stock (lowest first)
            suggestedOrders.sort((a, b) => {
                if (a.priority !== b.priority) {
                    const priorityOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return parseFloat(a.daysOfStock) - parseFloat(b.daysOfStock);
            });
            
            // Update table
            tbody.innerHTML = suggestedOrders.map(order => `
                <tr>
                    <td>${order.name}</td>
                    <td>${order.category}</td>
                    <td>${order.currentStock}</td>
                    <td>${order.salesVelocity} units/day</td>
                    <td>${order.daysOfStock} days</td>
                    <td>${order.suggestedOrder} units (‚Ç±${order.orderValue.toFixed(2)})</td>
                    <td><span class="stat-change ${order.priority === 'High' ? 'negative' : order.priority === 'Medium' ? 'warning' : 'positive'}">${order.priority}</span></td>
                </tr>
            `).join('');
        }



        // Search Functions
        function searchInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const category = document.getElementById('inventoryCategory').value;
            
            let filtered = inventory;
            
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) || 
                    item.sku.toLowerCase().includes(searchTerm)
                );
            }
            
            if (category !== 'All Categories') {
                filtered = filtered.filter(item => item.category === category);
            }
            
            // Update table with filtered results
            const tbody = document.getElementById('inventoryTable');
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">No items found matching your search</td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(item => `
                    <tr>
                        <td>${item.sku}</td>
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unitPrice.toFixed(2)}</td>
                        <td>${(item.quantity * item.unitPrice).toFixed(2)}</td>
                        <td>${new Date(item.updatedAt?.seconds * 1000 || Date.now()).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.5rem; font-size: 0.9rem;" 
                                    onclick="editInventoryItem('${item.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            showNotification(`Found ${filtered.length} items`, 'success');
        }

        function searchSales() {
            const searchTerm = document.getElementById('salesSearch').value.toLowerCase();
            const startDate = document.getElementById('salesStartDate').value;
            const endDate = document.getElementById('salesEndDate').value;
            
            let filtered = sales;
            
            if (searchTerm) {
                filtered = filtered.filter(sale => 
                    sale.itemName.toLowerCase().includes(searchTerm) || 
                    sale.itemSKU.toLowerCase().includes(searchTerm) ||
                    sale.customer.toLowerCase().includes(searchTerm)
                );
            }
            
            if (startDate) {
                filtered = filtered.filter(sale => {
                    const saleDate = new Date(sale.date?.seconds * 1000 || 0);
                    return saleDate >= new Date(startDate);
                });
            }
            
            if (endDate) {
                filtered = filtered.filter(sale => {
                    const saleDate = new Date(sale.date?.seconds * 1000 || 0);
                    return saleDate <= new Date(endDate + 'T23:59:59');
                });
            }
            
            // Update table with filtered results
            const tbody = document.getElementById('salesTable');
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">No sales records found matching your search</td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(sale => `
                    <tr>
                        <td>${sale.transactionId}</td>
                        <td>${new Date(sale.date?.seconds * 1000 || Date.now()).toLocaleDateString()}</td>
                        <td>${sale.customer}</td>
                        <td>${sale.itemSKU}</td>
                        <td>${sale.itemName}</td>
                        <td>${sale.quantity}</td>
                        <td>$${sale.unitPrice.toFixed(2)}</td>
                        <td>$${sale.total.toFixed(2)}</td>
                        <td><span class="stat-change positive">Completed</span></td>
                    </tr>
                `).join('');
            }
            
            showNotification(`Found ${filtered.length} sales records`, 'success');
        }

        function updateForecastCategories() {
            const select = document.getElementById('forecastCategory');
            // Get unique categories from inventory
            const categories = [...new Set(inventory.map(item => item.category))];
            
            select.innerHTML = '<option value="">All Categories</option>' +
                categories.map(category => 
                    `<option value="${category}">${category}</option>`
                ).join('');
        }

        let forecastChart = null;

        function initializeForecastChart() {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Current Stock',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Predicted Demand',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'Recommended Stock',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Inventory Forecast Analysis (‚Ç±)'
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        }
                    }
                }
            });
        }

        function updateForecastChart(data) {
            if (!forecastChart) {
                initializeForecastChart();
            }

            const labels = [];
            const currentStockData = [];
            const predictedDemandData = [];
            const recommendedStockData = [];
            const salesData = [];

            // Generate labels for each day
            for (let i = 0; i <= data.days; i++) {
                labels.push(`Day ${i}`);
            }

            // Calculate daily values
            const dailyConsumption = data.dailyDemand;
            let currentStock = data.currentStock;

            for (let i = 0; i <= data.days; i++) {
                currentStockData.push(Math.max(0, currentStock));
                predictedDemandData.push(dailyConsumption * i);
                
                // Recommended stock level (current stock + recommended order - consumption)
                const recommendedStock = i === 0 ? currentStock : 
                    Math.max(0, currentStock + data.recommendedOrder - (dailyConsumption * i));
                recommendedStockData.push(recommendedStock);
                
                // Add historical sales data if available
                if (data.salesData && i < data.salesData.length) {
                    const daySales = data.salesData
                        .filter(sale => {
                            let saleDate;
                            if (sale.invoiceDate) {
                                saleDate = new Date(sale.invoiceDate);
                            } else if (sale.date && sale.date.seconds) {
                                saleDate = new Date(sale.date.seconds * 1000);
                            } else if (sale.date) {
                                saleDate = new Date(sale.date);
                            } else {
                                return false;
                            }
                            return saleDate.getDate() === (new Date().getDate() - (data.salesData.length - 1 - i));
                        })
                        .reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                    salesData.push(daySales);
                } else {
                    salesData.push(0);
                }
                
                currentStock -= dailyConsumption;
            }

            // Update chart datasets
            forecastChart.data.labels = labels;
            forecastChart.data.datasets[0].data = currentStockData;
            forecastChart.data.datasets[1].data = predictedDemandData;
            forecastChart.data.datasets[2].data = recommendedStockData;
            
            // Add sales data if available
            if (data.salesData && forecastChart.data.datasets.length < 4) {
                forecastChart.data.datasets.push({
                    label: 'Historical Sales',
                    data: salesData,
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    tension: 0.1
                });
            } else if (data.salesData) {
                forecastChart.data.datasets[3].data = salesData;
            }
            
            // Update chart title to include growth rate
            const growthText = data.growthRate ? 
                ` (Growth: ${(data.growthRate * 100).toFixed(1)}%)` : '';
            forecastChart.options.plugins.title.text = `Inventory Forecast Analysis${growthText}`;
            
            forecastChart.update();
        }


        let dashboardChart = null;

        function initializeDashboardChart() {
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sales',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'Inventory Value',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sales vs Inventory Value Trend (‚Ç±)'
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Sales ($)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Inventory Value ($)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function updateDashboardChart() {
            if (!dashboardChart) {
                initializeDashboardChart();
            }

            // Get last 30 days data
            const labels = [];
            const salesData = [];
            const inventoryData = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString());
                
                // Calculate sales for this day
                const daySales = sales.filter(sale => {
                    const saleDate = new Date(sale.date?.seconds * 1000);
                    return saleDate.toDateString() === date.toDateString();
                }).reduce((sum, sale) => sum + sale.total, 0);
                salesData.push(daySales);

                // Calculate inventory value for this day
                const dayInventory = inventory.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
                inventoryData.push(dayInventory);
            }

            dashboardChart.data.labels = labels;
            dashboardChart.data.datasets[0].data = salesData;
            dashboardChart.data.datasets[1].data = inventoryData;
            dashboardChart.update();
        }

        function updateRecentActivities() {
            const tbody = document.getElementById('recentActivitiesTable');
            const activities = [];

            // Add recent sales
            sales.slice(0, 5).forEach(sale => {
                activities.push({
                    date: new Date(sale.date?.seconds * 1000 || Date.now()),
                    type: 'Sale',
                    item: sale.itemName,
                    quantity: sale.quantity,
                    status: 'Completed'
                });
            });

            // Add recent purchases
            purchases.slice(0, 5).forEach(purchase => {
                activities.push({
                    date: new Date(purchase.date?.seconds * 1000 || Date.now()),
                    type: 'Purchase',
                    item: purchase.itemName,
                    quantity: purchase.quantity,
                    status: purchase.status
                });
            });

            // Add recent orders
            orders.slice(0, 5).forEach(order => {
                activities.push({
                    date: new Date(order.orderDate?.seconds * 1000 || Date.now()),
                    type: 'Order',
                    item: order.itemName,
                    quantity: order.quantity,
                    status: order.status
                });
            });

            // Sort activities by date
            activities.sort((a, b) => b.date - a.date);

            // Update table
            tbody.innerHTML = activities.slice(0, 10).map(activity => `
                <tr>
                    <td>${activity.date.toLocaleDateString()}</td>
                    <td>${activity.type}</td>
                    <td>${activity.item}</td>
                    <td>${activity.quantity}</td>
                    <td><span class="stat-change ${activity.status === 'Pending' ? 'negative' : 'positive'}">${activity.status}</span></td>
                </tr>
            `).join('');
        }

        async function saveLowStockSettings() {
            const threshold = document.getElementById('defaultLowStockThreshold').value;
            const email = document.getElementById('lowStockAlertEmail').value;
            
            if (!currentCompany) {
                showNotification('Please select a company first', 'error');
                return;
            }

            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.firebase.db, 'companies', currentCompany),
                    {
                        lowStockThreshold: parseInt(threshold),
                        lowStockAlertEmail: email,
                        updatedAt: window.firebase.serverTimestamp()
                    }
                );
                showNotification('Low stock settings saved successfully', 'success');
            } catch (error) {
                showNotification('Error saving settings: ' + error.message, 'error');
            }
        }

        async function editInventoryItem(itemId) {
            const item = inventory.find(i => i.id === itemId);
            if (!item) return;

            const modalBody = `
                <form onsubmit="handleEditInventory(event)">
                    <input type="hidden" id="editItemId" value="${item.id}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-input" id="editItemName" value="${item.name}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">SKU</label>
                            <input type="text" class="form-input" id="editItemSKU" value="${item.sku}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-input" id="editItemCategory" value="${item.category}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="editItemQuantity" value="${item.quantity}" required min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit Price</label>
                            <input type="number" class="form-input" id="editItemPrice" value="${item.unitPrice}" required step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-input" id="editItemLocation" value="${item.location || ''}" placeholder="Warehouse location">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Low Stock Threshold</label>
                            <input type="number" class="form-input" id="editItemLowStockThreshold" value="${item.lowStockThreshold || 10}" min="0">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Item</button>
                    </div>
                </form>
            `;
            showModal('Edit Inventory Item', modalBody);
        }

        async function handleEditInventory(e) {
            e.preventDefault();
            
            const itemId = document.getElementById('editItemId').value;
            const updateData = {
                name: document.getElementById('editItemName').value,
                sku: document.getElementById('editItemSKU').value,
                category: document.getElementById('editItemCategory').value,
                quantity: parseInt(document.getElementById('editItemQuantity').value),
                unitPrice: parseFloat(document.getElementById('editItemPrice').value),
                location: document.getElementById('editItemLocation').value,
                lowStockThreshold: parseInt(document.getElementById('editItemLowStockThreshold').value) || 10,
                updatedAt: window.firebase.serverTimestamp()
            };

            showLoading(true);
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.firebase.db, 'inventory', itemId),
                    updateData
                );
                closeModal();
                await loadInventory();
                showNotification('Item updated successfully', 'success');
            } catch (error) {
                showNotification('Error updating item: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function searchForecast() {
            const searchTerm = document.getElementById('forecastSearch').value.toLowerCase();
            const category = document.getElementById('forecastCategory').value;
            
            let filtered = inventory;
            
            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) || 
                    item.sku.toLowerCase().includes(searchTerm)
                );
            }
            
            if (category !== 'All Categories') {
                filtered = filtered.filter(item => item.category === category);
            }
            
            // Update suggested orders table with filtered results
            updateSuggestedOrdersTable(filtered);
            
            showNotification(`Found ${filtered.length} items for forecast`, 'success');
        }

        function updateSuggestedOrdersTable(items) {
            const tbody = document.getElementById('suggestedOrdersTable');
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">No items found matching your search</td>
                    </tr>
                `;
                return;
            }
            
            const suggestedOrders = items.map(item => {
                const forecastDays = parseInt(document.getElementById('forecastDays').value);
                const suggestedOrder = Math.ceil(item.quantity * 0.7); // 70% of current stock
                
                return {
                    name: item.name,
                    category: item.category,
                    currentStock: item.quantity,
                    forecastDemand: suggestedOrder,
                    suggestedOrder: suggestedOrder,
                    priority: item.quantity < (item.lowStockThreshold || 10) ? 'High' : 'Medium'
                };
            });
            
            tbody.innerHTML = suggestedOrders.map(order => `
                <tr>
                    <td>${order.name}</td>
                    <td>${order.category}</td>
                    <td>${order.currentStock}</td>
                    <td>${order.forecastDemand}</td>
                    <td>${order.suggestedOrder}</td>
                    <td><span class="stat-change ${order.priority === 'High' ? 'negative' : 'positive'}">${order.priority}</span></td>
                </tr>
            `).join('');
        }
        
        function setInvoiceDateForImport(date) {
            const dateInput = document.getElementById('saleInvoiceDate');
            if (dateInput) {
                dateInput.value = date;
            }
        }





        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Attach login form handler
            document.getElementById('loginForm').addEventListener('submit', login);
            
            // Initialize charts
            initializeDashboardChart();
            initializeForecastChart();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (input.id.includes('End') || input.id.includes('To')) {
                    input.value = today;
                } else if (input.id.includes('Start') || input.id.includes('From')) {
                    input.value = lastMonth.toISOString().split('T')[0];
                }
            });
        });


    </script>
</body>
</html>